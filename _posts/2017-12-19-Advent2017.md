---
layout: post
title: 暮月語録（マルコフbot迷言集）
---

この記事は<a href="https://adventar.org/calendars/2106#list-2017-12-17">FUN Advent Calendar 2017</a>の19日目の記事です。  
18日は<a href="http://chikuwait.hatenablog.com/entry/2017/12/18/004807">ちくうぇいと</a>さんでした。

こんにちは、初参加の明石暁です。  
本記事では今年の6月あたりから稼働中のマルコフbotのまとめをやりつつ、中身にちょっとだけ触れます。  

---

## 概要
<a href="https://github.com/AkashiAkatsuki/Crescent">Crescent</a>は開発中のRuby製のマルコフbotです。  
暗石暮月(@kurashi_kure)がTwitter上で稼働中。  
MeCab、TwitterAPI、PostgreSQLなどを利用しています。  
TLの頻出単語からマルコフ連鎖を開始して文章を生成し、TLの速度に合わせた頻度でツイートします。  
また、単語は毎回検索でレパートリーを増やすようにしています。

### 暮月について
<a href="https://twitter.com/kurashi_kure?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-show-count="false">Follow @kurashi_kure</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>  
<a class="twitter-timeline" data-width="600" data-height="400" href="https://twitter.com/kurashi_kure?ref_src=twsrc%5Etfw">Tweets by kurashi_kure</a> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>  
こんなんです。  
 - 明石暁から 明→暗暁→明けの太陽→夕暮れの月→暮月 で暗石暮月
 - 誕生日は6/7
 - 最初はラズパイにいたけどConoHaに引っ越し ちなみにFedora

---

## 迷言集

<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">おはようにゃん💕</p>&mdash; 暗石暮月 (@kurashi_kure) <a href="https://twitter.com/kurashi_kure/status/922506129401249792?ref_src=twsrc%5Etfw">2017年10月23日</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<blockquote class="twitter-tweet" data-conversation="none" data-lang="ja"><p lang="ja" dir="ltr">なでなでしてぎゅーっして欲しい</p>&mdash; 暗石暮月 (@kurashi_kure) <a href="https://twitter.com/kurashi_kure/status/887271791512518656?ref_src=twsrc%5Etfw">2017年7月18日</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

あざとい

<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">大学から下山するかー</p>&mdash; 暗石暮月 (@kurashi_kure) <a href="https://twitter.com/kurashi_kure/status/928090285745123329?ref_src=twsrc%5Etfw">2017年11月8日</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">13時22時ごろに山岡家行きますー是非観て</p>&mdash; 暗石暮月 (@kurashi_kure) <a href="https://twitter.com/kurashi_kure/status/928109018207240192?ref_src=twsrc%5Etfw">2017年11月8日</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">いまから登山しに来られる人なんていやしないだろ</p>&mdash; 暗石暮月 (@kurashi_kure) <a href="https://twitter.com/kurashi_kure/status/933679358295793664?ref_src=twsrc%5Etfw">2017年11月23日</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

完全に未来大生

<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">単位がやばそうやなわたしどうしよ</p>&mdash; 暗石暮月 (@kurashi_kure) <a href="https://twitter.com/kurashi_kure/status/900564332114620416?ref_src=twsrc%5Etfw">2017年8月24日</a></blockquote>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">単位落としました((o</p>&mdash; 暗石暮月 (@kurashi_kure) <a href="https://twitter.com/kurashi_kure/status/912132450989387776?ref_src=twsrc%5Etfw">2017年9月25日</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

しかも落単芸人

<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">ホモは増殖する</p>&mdash; 暗石暮月 (@kurashi_kure) <a href="https://twitter.com/kurashi_kure/status/922130654430617605?ref_src=twsrc%5Etfw">2017年10月22日</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">ホモ多すぎます本当にありがとう☺</p>&mdash; 暗石暮月 (@kurashi_kure) <a href="https://twitter.com/kurashi_kure/status/924306308366417921?ref_src=twsrc%5Etfw">2017年10月28日</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

腐ってやがる

<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">彼女とデートなう</p>&mdash; 暗石暮月 (@kurashi_kure) <a href="https://twitter.com/kurashi_kure/status/886872624797593602?ref_src=twsrc%5Etfw">2017年7月17日</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">彼女といるってうれしい</p>&mdash; 暗石暮月 (@kurashi_kure) <a href="https://twitter.com/kurashi_kure/status/903640141368934400?ref_src=twsrc%5Etfw">2017年9月1日</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">女の子とにゃんにゃん</p>&mdash; 暗石暮月 (@kurashi_kure) <a href="https://twitter.com/kurashi_kure/status/942578444897984513?ref_src=twsrc%5Etfw">2017年12月18日</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

ｷﾏｼ

<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">リア充死ね</p>&mdash; 暗石暮月 (@kurashi_kure) <a href="https://twitter.com/kurashi_kure/status/886881428947877888?ref_src=twsrc%5Etfw">2017年7月17日</a></blockquote>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">リア充アピだ</p>&mdash; 暗石暮月 (@kurashi_kure) <a href="https://twitter.com/kurashi_kure/status/886904726595305472?ref_src=twsrc%5Etfw">2017年7月17日</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">リア充死ね</p>&mdash; 暗石暮月 (@kurashi_kure) <a href="https://twitter.com/kurashi_kure/status/888963773297442816?ref_src=twsrc%5Etfw">2017年7月23日</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">リア充死ね</p>&mdash; 暗石暮月 (@kurashi_kure) <a href="https://twitter.com/kurashi_kure/status/894898979976105985?ref_src=twsrc%5Etfw">2017年8月8日</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">リア充死ね</p>&mdash; 暗石暮月 (@kurashi_kure) <a href="https://twitter.com/kurashi_kure/status/915157022655504385?ref_src=twsrc%5Etfw">2017年10月3日</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

TLでリア充の話題が出るたびに言う
彼女持ちのくせに

<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">BaHoりのBaHo</p>&mdash; 暗石暮月 (@kurashi_kure) <a href="https://twitter.com/kurashi_kure/status/882834989389406209?ref_src=twsrc%5Etfw">2017年7月6日</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">BaHo寝取りのBaHo火照りのBaHo火照りのBaHo寝取りの</p>&mdash; 暗石暮月 (@kurashi_kure) <a href="https://twitter.com/kurashi_kure/status/883926491330826240?ref_src=twsrc%5Etfw">2017年7月9日</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">BaHoらずBaHoるときBaHoればBaHoれば</p>&mdash; 暗石暮月 (@kurashi_kure) <a href="https://twitter.com/kurashi_kure/status/887534044723855360?ref_src=twsrc%5Etfw">2017年7月19日</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

BaHo猫さんに捧ぐBaHoラップ
怒られたら消します

<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">みんな可愛いからしょうがないニャ</p>&mdash; 暗石暮月 (@kurashi_kure) <a href="https://twitter.com/kurashi_kure/status/927940522697564160?ref_src=twsrc%5Etfw">2017年11月7日</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">悲しみが深いめう(提案)</p>&mdash; 暗石暮月 (@kurashi_kure) <a href="https://twitter.com/kurashi_kure/status/883323426126962692?ref_src=twsrc%5Etfw">2017年7月7日</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">皿が絶対良いめうぽよ</p>&mdash; 暗石暮月 (@kurashi_kure) <a href="https://twitter.com/kurashi_kure/status/934824760734707712?ref_src=twsrc%5Etfw">2017年11月26日</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

最近語尾が増えてきた

<img src="/images/post_20171219.png">  
五回に一回くらいは会話がなんとなく成立するので、是非リプライして迷言を引き出してください。

## マルコフ連鎖の実装

~~このままだとただのTogetterになるので~~軽く中身の話します。  
Crescentで使われているマルコフ連鎖はRubyのArray.each_consを使って簡単に実装してます。

``` dictionary.rb:title
def self.learn(words)
  words.each_cons(3) do |w1, w2, w3|
    next if w1 == -1 || w2 == -1
    find_or_create_by(
      prefix1: w1.id,
      prefix2: w2.id,
      suffix:  w3.id)
  end
end
```
each_consは、任意の数の要素を一つずつズラしながらeachを回せる、マルコフ連鎖のために存在するかのようなメソッドです  
wordsは文章をMeCabで解体して単語DBのidに並べ替えた配列です。  
これを3つずつ取り出してマルコフDBに登録していきます。  
文末が来たら飛ばして次の文またはループを抜けます。  

文章の生成はこんな感じです。  

```
def self.generate(word_id)
  keyword = Word.find_by(id: word_id)
  seq = Array[word_id]
  first_list = where("prefix1 = ?", word_id)
  return keyword.name if first_list.empty?
  seq.push first_list.sample.prefix2
  CHAIN_MAX.times do
    choice = Markov.where("(prefix1 = ?) and (prefix2 = ?)", seq.last(2)[0], seq.last(2)[1]).sample.suffix
    break if choice == -1
    redo if [true, false].sample && (Word.find(choice).value - keyword.value).abs > 1
    suffix = choice
    seq.push suffix
  end
  .
  .
  .
```

まず引数のword_idから起点の単語になるkeywordを取ってきます。  
seqは単語の順番をidで保持する配列です。  
マルコフDBから、keywordから始まる並びを探してランダムで一つ決めて2文字目をseqに入れます。  
次のループ内では、1文字目と2文字目が一致する並びを探して、3文字目をseqに入れます。  
これはCHAIN_MAX回繰り返すか、文末に到達したら終了し、その後seq内のword_idから文字列を呼び出して文章を組み立て（省略）です。  

## おわりに
暮月はフォロワーの皆さんのツイートとクソリプで支えられています。これからもどうぞかまってやってください。  
好感度機能や単語に対する興味度の機能など、もっと改良していく予定です。  
でもとりあえエラー吐きまくりなのをなんとかしたいと思います…。  

次回はやまけん(@yamakentoc)さんです。